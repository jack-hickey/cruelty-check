class Product{constructor(e){this.Name=e.Name,this.Vegan=1===e.Is_Vegan,this.Image=e.Image,this.PalmOil=1===e.Palm_Oil,this.Brands=(JSON.parse(e.Brand_Hierarchy)??[]).map(e=>new Brand(e)).sort((e,t)=>e.Level-t.Level),this.Brand=this.Brands.at(0)??new Brand}static search=e=>new Promise(t=>Ajax.Post("search",{body:{query:e},success:{ok:e=>t(e.body.map(e=>new Product(e))),any:e=>{e.ok||t([])}}}));static#ResetBrandScreen(){[txtBrandName,drpBrandParent].forEach(e=>e.value=""),drpBrandParent.text="",drpBrandParent.text="Choose a brand",[cbCrueltyFree,cbBCorp,cbAnimalTesting].forEach(e=>e.checked=!1)}static add(){let r=null;Dialog.ShowCustom(Localizer.ADD_PRODUCT_TITLE,Localizer.ADD_PRODUCT_DESC,`
				<chip-tabgroup id="tgAddProduct" skip-validation>
					<chip-tab>
						<chip-form>
							<chip-input
								id="txtProductName"
								required
								min-length="2"
								max-length="100"
								label="Product name">
							</chip-input>

							<chip-dropdown
								id="drpBrands"
								class="mt-form brand-selector"
								default="Choose a brand"
								required
								searchable
								label="Brand">
							</chip-dropdown>

							<chip-header size="5" class="mt-form--lg">This product:</chip-header>

							<chip-list class="mt-md" gap="sm">
								<chip-listitem>
									<chip-checkbox
										id="cbVegan"
										helper-text="Tick if there are no animal-derived or ambiguous ingredients."
										label="Is vegan"
									</chip-checkbox>
								</chip-listitem>
								<chip-listitem>
									<chip-checkbox
										id="cbPalmOil"
										label="Contains unsustainable palm oil"
									</chip-checkbox>
								</chip-listitem>
							</chip-list>

							<chip-header
								class="mt-form--lg mb-xs"
								size="4">
								Upload an image
							</chip-header>
							<chip-text>
								Please upload an official product image, not personal photos. That means no selfies!
							</chip-text>
							<div class="d-flex flex-column gap-sm mt-md">
								<img role="presentation" id="imgProduct" loading="lazy" />
								<chip-button
									id="btnProductImage"
									class="w-fit"
									variation="info">
									Upload
								</chip-button>
								<chip-text class="d-none" variation="danger" size="sm" id="ctImageValidation">
									Please upload an image
								</chip-text>
							</div>
						</chip-form>
					</chip-tab>
					<chip-tab>
						<chip-header class="mb-lg" size="4">Add a new brand</chip-header>

						<chip-form id="frmBrand">
							<chip-input
								id="txtBrandName"
								min-length="2"
								max-length="50"
								required
								label="Brand name">
							</chip-input>

							<chip-dropdown
								id="drpBrandParent"
								searchable
								default="Choose a brand"
								helper-text="Please review whether or not this brand is owned by a parent company."
								class="mt-form brand-selector"
								secondary-label="(optional)"
								label="Parent company">
							</chip-dropdown>

							<chip-header size="5" class="mt-form">This brand:</chip-header>

							<chip-list class="mt-md" gap="xs">
								<chip-listitem>
									<chip-checkbox
										id="cbCrueltyFree"
										label="Is certified cruelty-free">
									</chip-checkbox>
								</chip-listitem>
								<chip-listitem>
									<chip-checkbox
										id="cbBCorp"
										label="Is a B Corporation">
									</chip-checkbox>
								</chip-listitem>
								<chip-listitem>
									<chip-checkbox
										id="cbAnimalTesting"
										label="Permits animal testing">
									</chip-checkbox>
								</chip-listitem>
							</chip-list>

							<div class="h-align ms-auto w-fit gap-sm mt-card">
								<chip-button
									step-direction="previous"
									variation="info-tertiary"
									icon="fas fa-chevron-left">
									Back
								</chip-button>
								<chip-button
									id="btnAddBrand">
									Add brand
								</chip-button>
							</div>
						</chip-form>
					</chip-tab>
				</chip-tabgroup>
			`,{Size:"md",Scrollable:!0,OnRefreshEvents:i=>{FileUploader.Initialize({Buttons:[i.querySelector("#btnProductImage")],AllowedExtensions:["png","jpg","jpeg","webp","svg"],OnComplete:async e=>{r=e.at(0);e=ctImageValidation.textContent===Localizer.IMAGE_TOO_LARGE;r?(r=await r.compress(),ctImageValidation.toggleClass("d-none",!e),imgProduct.src=r.getImageSrc()):e||(ctImageValidation.textContent=Localizer.IMAGE_MISSING,ctImageValidation.classList.add("d-none"))},OnFileTooLarge:()=>{ctImageValidation.textContent=Localizer.IMAGE_TOO_LARGE,ctImageValidation.classList.remove("d-none")}});let e=i.querySelector("chip-tabgroup");e.onchange=()=>{document.querySelector(".dialog .card-footer").toggleClass("d-none",1===e.selectedIndex)},i.querySelector("#btnAddBrand").onclick=()=>{i.querySelector("#frmBrand").reportValidity()&&Ajax.Post("addbrand",{body:{Name:txtBrandName.value.trim(),ParentID:parseInt(drpBrandParent.value)||null,CrueltyFree:cbCrueltyFree.checked,BCorp:cbBCorp.checked,AnimalTesting:cbAnimalTesting.checked},success:{ok:()=>{i.querySelector("chip-tab").Select(),this.#ResetBrandScreen()}}})},i.querySelectorAll(".brand-selector").forEach(a=>a.GetSearchedItems=async e=>{var t=[],t=(await Brand.getAll(e)).map(e=>document.createElementWithContents("chip-dropdownitem",e.Name,{value:e.ID}));return a.onselectionchange=()=>{"0"===a.value&&(i.querySelector("chip-tab + chip-tab").Select(),this.#ResetBrandScreen(),a.value="")},t.length&&t.unshift(document.createElement("chip-dropdowndivider")),t.unshift(document.createElementWithContents("chip-dropdownitem","Add new brand",{icon:"fas fa-plus",value:0})),t})},OnCheckValid:e=>{let t=e.querySelector("chip-form").reportValidity(),a=e.querySelector("#ctImageValidation");return r?a.classList.add("d-none"):(ctImageValidation.textContent=Localizer.IMAGE_MISSING,t=!1,a.classList.remove("d-none")),t},AffirmativeText:"Submit"}).then(()=>Ajax.Post("addproduct",{body:Browser.ToFormData({Name:txtProductName.value.trim(),BrandID:parseInt(drpBrands.value)||0,Vegan:cbVegan.checked,PalmOil:cbPalmOil.checked,Image:r}),success:{ok:e=>{Dialog.ShowSuccess("Product submitted","Thank you for submitting a new product to Cruelty Check! Your submission has been sent for review and will be visible on the site once accepted.")}}}))}getAdvisories(){let e=this.Brands.find(e=>e.AnimalTesting),t=this.Brands.find(e=>!e.CrueltyFree);var a,i=[{id:"palm_oil",condition:()=>this.PalmOil,message:()=>"This product contains unsustainably sourced palm oil.",blocks:[]},{id:"brand_testing",condition:()=>!!e,message:()=>`${e.Name}${e.ID!==this.Brand.ID?", a predecessor of "+this.Brand.Name+",":""} conducts, funds or otherwise permits animal testing.`,blocks:["brand_parent_contrast"]},{id:"brand_parent_contrast",condition:()=>this.Brand.CrueltyFree&&!!t,message:()=>`While ${this.Brand.Name} is cruelty-free, ${t.Name}, a predecessor of ${this.Brand.Name} is not and may own non-cruelty-free brands.`,blocks:[]}];let r=[],n=new Set;for(a of i)!n.has(a.id)&&a.condition()&&(r.push(a.message()),a.blocks.forEach(e=>n.add(e)));return r.join("<br/><br/>")}reportIncorrect(){Dialog.ShowTextBox(Localizer.INCORRECT_INFORMATION_TITLE,Localizer.INCORRECT_INFORMATION_DESC,{Rows:12,AffirmativeText:"Submit",Multiline:!0}).then(e=>{report("INCORRECT-INFO","Incorrect Product Information",`Using the built in feedback feature, a user has reported that **${this.Name}** by **${this.Brand.Name}** has incorrect information, stating:
>`+e)})}}