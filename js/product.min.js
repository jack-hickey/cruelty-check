class Product{constructor(t){this.Name=t.Name,this.Vegan=1===t.Is_Vegan,this.Image=t.Image,this.Brands=(JSON.parse(t.Brand_Hierarchy)??[]).map(t=>new Brand(t)).sort((t,e)=>t.Level-e.Level),this.Brand=this.Brands.at(0)??new Brand,console.log(t)}static search=t=>new Promise(e=>Ajax.Post("search",{body:{query:t},success:{ok:t=>e(t.body.map(t=>new Product(t))),any:t=>{t.ok||e([])}}}));static#t(){[txtBrandName,drpBrandParent].forEach(t=>t.value=""),drpBrandParent.text="",drpBrandParent.text="Choose a brand",[cbCrueltyFree,cbBCorp,cbAnimalTesting].forEach(t=>t.checked=!1)}static add(){let t=null;Dialog.ShowCustom(Localizer.ADD_PRODUCT_TITLE,Localizer.ADD_PRODUCT_DESC,'\n\t\t\t\t<chip-tabgroup id="tgAddProduct" skip-validation>\n\t\t\t\t\t<chip-tab>\n\t\t\t\t\t\t<chip-form>\n\t\t\t\t\t\t\t<chip-input\n\t\t\t\t\t\t\t\tid="txtProductName"\n\t\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\t\tmin-length="2"\n\t\t\t\t\t\t\t\tmax-length="100"\n\t\t\t\t\t\t\t\tlabel="Product name">\n\t\t\t\t\t\t\t</chip-input>\n\n\t\t\t\t\t\t\t<chip-dropdown\n\t\t\t\t\t\t\t\tid="drpBrands"\n\t\t\t\t\t\t\t\tclass="mt-form brand-selector"\n\t\t\t\t\t\t\t\tdefault="Choose a brand"\n\t\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\t\tsearchable\n\t\t\t\t\t\t\t\tlabel="Brand">\n\t\t\t\t\t\t\t</chip-dropdown>\n\n\t\t\t\t\t\t\t<chip-header size="5" class="mt-form--lg">This product:</chip-header>\n\n\t\t\t\t\t\t\t<chip-list class="mt-md" gap="sm">\n\t\t\t\t\t\t\t\t<chip-listitem>\n\t\t\t\t\t\t\t\t\t<chip-checkbox\n\t\t\t\t\t\t\t\t\t\tid="cbVegan"\n\t\t\t\t\t\t\t\t\t\thelper-text="Tick if there are no animal-derived or ambiguous ingredients."\n\t\t\t\t\t\t\t\t\t\tlabel="Is vegan"\n\t\t\t\t\t\t\t\t\t</chip-checkbox>\n\t\t\t\t\t\t\t\t</chip-listitem>\n\t\t\t\t\t\t\t\t<chip-listitem>\n\t\t\t\t\t\t\t\t\t<chip-checkbox\n\t\t\t\t\t\t\t\t\t\tid="cbFairtrade"\n\t\t\t\t\t\t\t\t\t\tlabel="Is Fairtrade certified">\n\t\t\t\t\t\t\t\t\t</chip-checkbox>\n\t\t\t\t\t\t\t\t</chip-listitem>\n\t\t\t\t\t\t\t</chip-list>\n\n\t\t\t\t\t\t\t<chip-header\n\t\t\t\t\t\t\t\tclass="mt-form--lg mb-xs"\n\t\t\t\t\t\t\t\tsize="4">\n\t\t\t\t\t\t\t\tUpload an image\n\t\t\t\t\t\t\t</chip-header>\n\t\t\t\t\t\t\t<chip-text>\n\t\t\t\t\t\t\t\tPlease upload an official product image, not personal photos. That means no selfies!\n\t\t\t\t\t\t\t</chip-text>\n\t\t\t\t\t\t\t<div class="d-flex flex-column gap-sm mt-md">\n\t\t\t\t\t\t\t\t<img role="presentation" id="imgProduct" loading="lazy" />\n\t\t\t\t\t\t\t\t<chip-button\n\t\t\t\t\t\t\t\t\tid="btnProductImage"\n\t\t\t\t\t\t\t\t\tclass="w-fit"\n\t\t\t\t\t\t\t\t\tvariation="info">\n\t\t\t\t\t\t\t\t\tUpload\n\t\t\t\t\t\t\t\t</chip-button>\n\t\t\t\t\t\t\t\t<chip-text class="d-none" variation="danger" size="sm" id="ctImageValidation">\n\t\t\t\t\t\t\t\t\tPlease upload an image\n\t\t\t\t\t\t\t\t</chip-text>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</chip-form>\n\t\t\t\t\t</chip-tab>\n\t\t\t\t\t<chip-tab>\n\t\t\t\t\t\t<chip-header class="mb-lg" size="4">Add a new brand</chip-header>\n\n\t\t\t\t\t\t<chip-form id="frmBrand">\n\t\t\t\t\t\t\t<chip-input\n\t\t\t\t\t\t\t\tid="txtBrandName"\n\t\t\t\t\t\t\t\tmin-length="2"\n\t\t\t\t\t\t\t\tmax-length="50"\n\t\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\t\tlabel="Brand name">\n\t\t\t\t\t\t\t</chip-input>\n\n\t\t\t\t\t\t\t<chip-dropdown\n\t\t\t\t\t\t\t\tid="drpBrandParent"\n\t\t\t\t\t\t\t\tsearchable\n\t\t\t\t\t\t\t\tdefault="Choose a brand"\n\t\t\t\t\t\t\t\thelper-text="Please review whether or not this brand is owned by a parent company."\n\t\t\t\t\t\t\t\tclass="mt-form brand-selector"\n\t\t\t\t\t\t\t\tsecondary-label="(optional)"\n\t\t\t\t\t\t\t\tlabel="Parent company">\n\t\t\t\t\t\t\t</chip-dropdown>\n\n\t\t\t\t\t\t\t<chip-header size="5" class="mt-form">This brand:</chip-header>\n\n\t\t\t\t\t\t\t<chip-list class="mt-md" gap="xs">\n\t\t\t\t\t\t\t\t<chip-listitem>\n\t\t\t\t\t\t\t\t\t<chip-checkbox\n\t\t\t\t\t\t\t\t\t\tid="cbCrueltyFree"\n\t\t\t\t\t\t\t\t\t\tlabel="Is certified cruelty-free">\n\t\t\t\t\t\t\t\t\t</chip-checkbox>\n\t\t\t\t\t\t\t\t</chip-listitem>\n\t\t\t\t\t\t\t\t<chip-listitem>\n\t\t\t\t\t\t\t\t\t<chip-checkbox\n\t\t\t\t\t\t\t\t\t\tid="cbBCorp"\n\t\t\t\t\t\t\t\t\t\tlabel="Is a B Corporation">\n\t\t\t\t\t\t\t\t\t</chip-checkbox>\n\t\t\t\t\t\t\t\t</chip-listitem>\n\t\t\t\t\t\t\t\t<chip-listitem>\n\t\t\t\t\t\t\t\t\t<chip-checkbox\n\t\t\t\t\t\t\t\t\t\tid="cbAnimalTesting"\n\t\t\t\t\t\t\t\t\t\tlabel="Permits animal testing">\n\t\t\t\t\t\t\t\t\t</chip-checkbox>\n\t\t\t\t\t\t\t\t</chip-listitem>\n\t\t\t\t\t\t\t</chip-list>\n\n\t\t\t\t\t\t\t<div class="h-align ms-auto w-fit gap-sm mt-card">\n\t\t\t\t\t\t\t\t<chip-button\n\t\t\t\t\t\t\t\t\tstep-direction="previous"\n\t\t\t\t\t\t\t\t\tvariation="info-tertiary"\n\t\t\t\t\t\t\t\t\ticon="fas fa-chevron-left">\n\t\t\t\t\t\t\t\t\tBack\n\t\t\t\t\t\t\t\t</chip-button>\n\t\t\t\t\t\t\t\t<chip-button\n\t\t\t\t\t\t\t\t\tid="btnAddBrand">\n\t\t\t\t\t\t\t\t\tAdd brand\n\t\t\t\t\t\t\t\t</chip-button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</chip-form>\n\t\t\t\t\t</chip-tab>\n\t\t\t\t</chip-tabgroup>\n\t\t\t',{Size:"md",Scrollable:!0,OnRefreshEvents:e=>{FileUploader.Initialize({Buttons:[e.querySelector("#btnProductImage")],AllowedExtensions:["png","jpg","jpeg","webp","svg"],OnComplete:e=>{t=e.at(0);const n=ctImageValidation.textContent===Localizer.IMAGE_TOO_LARGE;t?(ctImageValidation.toggleClass("d-none",!n),imgProduct.src=t.getImageSrc()):n||(ctImageValidation.textContent=Localizer.IMAGE_MISSING,ctImageValidation.classList.add("d-none"))},OnFileTooLarge:()=>{ctImageValidation.textContent=Localizer.IMAGE_TOO_LARGE,ctImageValidation.classList.remove("d-none")}});const n=e.querySelector("chip-tabgroup");n.onchange=()=>{document.querySelector(".dialog .card-footer").toggleClass("d-none",1===n.selectedIndex)},e.querySelector("#btnAddBrand").onclick=()=>{e.querySelector("#frmBrand").reportValidity()&&Ajax.Post("addbrand",{body:{Name:txtBrandName.value.trim(),ParentID:parseInt(drpBrandParent.value)||null,CrueltyFree:cbCrueltyFree.checked,BCorp:cbBCorp.checked,AnimalTesting:cbAnimalTesting.checked},success:{ok:()=>{e.querySelector("chip-tab").Select(),this.#t()}}})},e.querySelectorAll(".brand-selector").forEach(t=>t.GetSearchedItems=async n=>{let a=[];return a=(await Brand.getAll(n)).map(t=>document.createElementWithContents("chip-dropdownitem",t.Name,{value:t.ID})),t.onselectionchange=()=>{"0"===t.value&&(e.querySelector("chip-tab + chip-tab").Select(),this.#t(),t.value="")},a.length&&a.unshift(document.createElement("chip-dropdowndivider")),a.unshift(document.createElementWithContents("chip-dropdownitem","Add new brand",{icon:"fas fa-plus",value:0})),a})},OnCheckValid:e=>{let n=e.querySelector("chip-form").reportValidity(),a=e.querySelector("#ctImageValidation");return t?a.classList.add("d-none"):(ctImageValidation.textContent=Localizer.IMAGE_MISSING,n=!1,a.classList.remove("d-none")),n},AffirmativeText:"Submit"}).then(()=>Ajax.Post("addproduct",{body:Browser.ToFormData({Name:txtProductName.value.trim(),BrandID:parseInt(drpBrands.value)||0,Vegan:cbVegan.checked,Fairtrade:cbFairtrade.checked,Image:t}),success:{ok:t=>{Dialog.ShowSuccess("Product submitted","Thank you for submitting a new product to Cruelty Check! Your submission has been sent for review and will be visible on the site once accepted.")}}}))}getAdvisories(){const t=this.Brands.find(t=>t.AnimalTesting),e=this.Brands.find(t=>!t.CrueltyFree),n=[{id:"brand_testing",condition:()=>!!t,message:()=>`${t.Name}${t.ID!==this.Brand.ID?", a predecessor of "+this.Brand.Name+",":""} conducts or funds animal testing when required by law or voluntarily.`,blocks:["brand_parent_contrast"]},{id:"brand_parent_contrast",condition:()=>this.Brand.CrueltyFree&&!!e,message:()=>`While ${this.Brand.Name} is cruelty-free, ${e.Name}, a predecessor of ${this.Brand.Name} is not and may own non-cruelty-free brands.`,blocks:[]}],a=[],i=new Set;for(const t of n)!i.has(t.id)&&t.condition()&&(a.push(t.message()),t.blocks.forEach(t=>i.add(t)));return a.join("<br/><br/>")}reportIncorrect(){Dialog.ShowTextBox(Localizer.INCORRECT_INFORMATION_TITLE,Localizer.INCORRECT_INFORMATION_DESC,{Rows:12,AffirmativeText:"Submit",Multiline:!0}).then(t=>{report("INCORRECT-INFO","Incorrect Product Information",`Using the built in feedback feature, a user has reported that **${this.Name}** by **${this.Brand.Name}** has incorrect information, stating:\n>${t}`)})}}