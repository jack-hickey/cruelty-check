var __defProp=Object.defineProperty,__name=(e,t)=>__defProp(e,"name",{value:t,configurable:!0});async function onRequest(e){const{env:t,params:n}=e,a=n.filename;if(!a)return new Response("File not specified",{status:400});const r=await t.R2_BUCKET.get(a);return r?new Response(r.body,{headers:{"Content-Type":r.httpMetadata.contentType||"application/octet-stream","Cache-Control":"public, max-age=31536000"}}):new Response("File not found",{status:404})}async function onRequestAddProduct(e){const{request:t,env:n}=e;let a;try{a=await t.json()}catch{return new Response("Invalid JSON",{status:400})}if(!a.Name||!a.BrandID)return new Response("Invalid JSON",{status:400});const{results:r}=await n.DATABASE.prepare("INSERT INTO Products (Name, Brand_ID, Is_Vegan) VALUES (?, ?, ?)").bind(a.Name,a.BrandID,a.Vegan?1:0).run();return new Response("Ok",{status:200})}async function onRequestBrands(e){const{request:t,env:n}=e;let a;try{a=await t.json()}catch{return new Response("Invalid JSON",{status:400})}const{results:r}=await n.DATABASE.prepare("SELECT * FROM Brands WHERE INSTR(LOWER(Name), ?) > 0 ORDER BY Name").bind(a.query.toLowerCase()).all();return Response.json(r)}async function onRequestPost(e){const{request:t,env:n}=e;let a;try{a=await t.json()}catch{return new Response("Invalid JSON",{status:400})}const r=(a.query||"").trim().toLowerCase().split(/\s+/),o=[],s=[],i=[];r.forEach(e=>{o.push("(INSTR(LOWER(p.Name), ?) > 0)"),o.push("(INSTR(LOWER(b.Name), ?) > 0)"),s.push("(INSTR(LOWER(p.Name), ?) > 0 OR INSTR(LOWER(b.Name), ?) > 0)"),i.push(e,e)}),r.forEach(e=>{i.push(e,e)});const c=`\n\t\tSELECT \n   \t\tp.ID,\n    \tp.Name,\n\t\t\tp.Image,\n\t\t\tp.Is_Vegan,\n    \tb.Name AS Brand,\n    \tb.Cruelty_Free,\n\t\t\tb.Animal_Testing,\n\t\t\tpb.Name As Parent_Brand,\n    \tpb.Cruelty_Free AS Parent_Cruelty_Free,\n\t\t\tpb.Animal_Testing AS Parent_Animal_Testing,\n    \t(${o.join(" + ")}) AS score\n\t\tFROM Products p\n\t\tLEFT JOIN Brands b ON b.ID = p.Brand_ID\n\t\tLEFT JOIN Brands pb ON pb.ID = b.Parent_ID\n\t\tWHERE ${s.join(" OR ")}\n\t\tAND p.Accepted = 1\n\t\tORDER BY score DESC;\n  `,{results:u}=await n.DATABASE.prepare(c).bind(...i).all();return Response.json(u)}async function onRequest2(e){if("POST"!==e.request.method)return new Response("Method Not Allowed",{status:405});let t=await e.request.json(),n="Unknown",a=e.request.headers.get("user-agent").toLowerCase(),r=[{name:"Edge",regex:/edg/},{name:"Opera",regex:/(opera|opr)/},{name:"Vivaldi",regex:/vivaldi/},{name:"Brave",regex:/brave/},{name:"Chrome",regex:/chrome/,exclude:/(edg|opr|vivaldi|brave)/},{name:"Firefox",regex:/firefox/},{name:"Safari",regex:/safari/,exclude:/chrome|chromium|crios/},{name:"Samsung Internet",regex:/samsungbrowser/},{name:"Internet Explorer",regex:/msie|trident/}].find(e=>e.regex.test(a)&&(!e.exclude||!e.exclude.test(a)))?.name??"Unknown";if(/Windows NT 10\.0/i.test(a)?n="Windows 10/11":/Windows NT 6\.3/i.test(a)?n="Windows 8.1":/Windows NT 6\.2/i.test(a)?n="Windows 8":/Windows NT 6\.1/i.test(a)?n="Windows 7":/Windows Phone|IEMobile/i.test(a)?n="Windows Phone":/Macintosh|Mac OS X/i.test(a)?n="macOS":/CrOS/i.test(a)?n="ChromeOS":/Linux/i.test(a)?n="Linux":/Android/i.test(a)?n="Android":/iPhone|iPad|iPod/i.test(a)&&(n="iOS"),!t.title||!t.description||!t.type)return new Response("Bad Request",{status:400});const o=`### Details\n${t.description}\n### Source\nBrowser: ${r}\nOperating System: ${n}`,s=await fetch(`https://api.github.com/repos/${e.env.GITHUB_REPO}/issues`,{method:"POST",headers:{Authorization:`token ${e.env.GITHUB_TOKEN}`,Accept:"application/vnd.github+json","User-Agent":"cloudflare-pages-form"},body:JSON.stringify({title:t.title,body:o,labels:[t.type.toLowerCase()],assignee:"jack-hickey"})});return s.ok?new Response("",{status:200}):new Response(await s.text(),{status:s.status})}__name(onRequest,"onRequest"),__name(onRequestAddProduct,"onRequestPost"),__name(onRequestBrands,"onRequestPost"),__name(onRequestPost,"onRequestPost"),__name(onRequest2,"onRequest");var routes=[{routePath:"/products/:filename",mountPath:"/products",method:"",middlewares:[],modules:[onRequest]},{routePath:"/addproduct",mountPath:"/",method:"POST",middlewares:[],modules:[onRequestAddProduct]},{routePath:"/search",mountPath:"/",method:"POST",middlewares:[],modules:[onRequestPost]},{routePath:"/brands",mountPath:"/",method:"POST",middlewares:[],modules:[onRequestBrands]},{routePath:"/report",mountPath:"/",method:"",middlewares:[],modules:[onRequest2]}];function lexer(e){for(var t=[],n=0;n<e.length;){var a=e[n];if("*"!==a&&"+"!==a&&"?"!==a)if("\\"!==a)if("{"!==a)if("}"!==a)if(":"!==a)if("("!==a)t.push({type:"CHAR",index:n,value:e[n++]});else{var r=1,o="";if("?"===e[i=n+1])throw new TypeError('Pattern cannot start with "?" at '.concat(i));for(;i<e.length;)if("\\"!==e[i]){if(")"===e[i]){if(0===--r){i++;break}}else if("("===e[i]&&(r++,"?"!==e[i+1]))throw new TypeError("Capturing groups are not allowed at ".concat(i));o+=e[i++]}else o+=e[i++]+e[i++];if(r)throw new TypeError("Unbalanced pattern at ".concat(n));if(!o)throw new TypeError("Missing pattern at ".concat(n));t.push({type:"PATTERN",index:n,value:o}),n=i}else{for(var s="",i=n+1;i<e.length;){var c=e.charCodeAt(i);if(!(c>=48&&c<=57||c>=65&&c<=90||c>=97&&c<=122||95===c))break;s+=e[i++]}if(!s)throw new TypeError("Missing parameter name at ".concat(n));t.push({type:"NAME",index:n,value:s}),n=i}else t.push({type:"CLOSE",index:n,value:e[n++]});else t.push({type:"OPEN",index:n,value:e[n++]});else t.push({type:"ESCAPED_CHAR",index:n++,value:e[n++]});else t.push({type:"MODIFIER",index:n,value:e[n++]})}return t.push({type:"END",index:n,value:""}),t}function parse(e,t){void 0===t&&(t={});for(var n=lexer(e),a=t.prefixes,r=void 0===a?"./":a,o=t.delimiter,s=void 0===o?"/#?":o,i=[],c=0,u=0,p="",d=__name(function(e){if(u<n.length&&n[u].type===e)return n[u++].value},"tryConsume"),f=__name(function(e){var t=d(e);if(void 0!==t)return t;var a=n[u],r=a.type,o=a.index;throw new TypeError("Unexpected ".concat(r," at ").concat(o,", expected ").concat(e))},"mustConsume"),l=__name(function(){for(var e,t="";e=d("CHAR")||d("ESCAPED_CHAR");)t+=e;return t},"consumeText"),m=__name(function(e){for(var t=0,n=s;t<n.length;t++){var a=n[t];if(e.indexOf(a)>-1)return!0}return!1},"isSafe"),h=__name(function(e){var t=i[i.length-1],n=e||(t&&"string"==typeof t?t:"");if(t&&!n)throw new TypeError('Must have text between two parameters, missing text after "'.concat(t.name,'"'));return!n||m(n)?"[^".concat(escapeString(s),"]+?"):"(?:(?!".concat(escapeString(n),")[^").concat(escapeString(s),"])+?")},"safePattern");u<n.length;){var g=d("CHAR"),R=d("NAME"),x=d("PATTERN");if(R||x){var w=g||"";-1===r.indexOf(w)&&(p+=w,w=""),p&&(i.push(p),p=""),i.push({name:R||c++,prefix:w,suffix:"",pattern:x||h(w),modifier:d("MODIFIER")||""})}else{var _=g||d("ESCAPED_CHAR");if(_)p+=_;else if(p&&(i.push(p),p=""),d("OPEN")){w=l();var v=d("NAME")||"",T=d("PATTERN")||"",E=l();f("CLOSE"),i.push({name:v||(T?c++:""),pattern:v&&!T?h(w):T,prefix:w,suffix:E,modifier:d("MODIFIER")||""})}else f("END")}}return i}function match(e,t){var n=[];return regexpToFunction(pathToRegexp(e,n,t),n,t)}function regexpToFunction(e,t,n){void 0===n&&(n={});var a=n.decode,r=void 0===a?function(e){return e}:a;return function(n){var a=e.exec(n);if(!a)return!1;for(var o=a[0],s=a.index,i=Object.create(null),c=__name(function(e){if(void 0===a[e])return"continue";var n=t[e-1];"*"===n.modifier||"+"===n.modifier?i[n.name]=a[e].split(n.prefix+n.suffix).map(function(e){return r(e,n)}):i[n.name]=r(a[e],n)},"_loop_1"),u=1;u<a.length;u++)c(u);return{path:o,index:s,params:i}}}function escapeString(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function flags(e){return e&&e.sensitive?"":"i"}function regexpToRegexp(e,t){if(!t)return e;for(var n=/\((?:\?<(.*?)>)?(?!\?)/g,a=0,r=n.exec(e.source);r;)t.push({name:r[1]||a++,prefix:"",suffix:"",modifier:"",pattern:""}),r=n.exec(e.source);return e}function arrayToRegexp(e,t,n){var a=e.map(function(e){return pathToRegexp(e,t,n).source});return new RegExp("(?:".concat(a.join("|"),")"),flags(n))}function stringToRegexp(e,t,n){return tokensToRegexp(parse(e,n),t,n)}function tokensToRegexp(e,t,n){void 0===n&&(n={});for(var a=n.strict,r=void 0!==a&&a,o=n.start,s=void 0===o||o,i=n.end,c=void 0===i||i,u=n.encode,p=void 0===u?function(e){return e}:u,d=n.delimiter,f=void 0===d?"/#?":d,l=n.endsWith,m="[".concat(escapeString(void 0===l?"":l),"]|$"),h="[".concat(escapeString(f),"]"),g=s?"^":"",R=0,x=e;R<x.length;R++){var w=x[R];if("string"==typeof w)g+=escapeString(p(w));else{var _=escapeString(p(w.prefix)),v=escapeString(p(w.suffix));if(w.pattern)if(t&&t.push(w),_||v)if("+"===w.modifier||"*"===w.modifier){var T="*"===w.modifier?"?":"";g+="(?:".concat(_,"((?:").concat(w.pattern,")(?:").concat(v).concat(_,"(?:").concat(w.pattern,"))*)").concat(v,")").concat(T)}else g+="(?:".concat(_,"(").concat(w.pattern,")").concat(v,")").concat(w.modifier);else{if("+"===w.modifier||"*"===w.modifier)throw new TypeError('Can not repeat "'.concat(w.name,'" without a prefix and suffix'));g+="(".concat(w.pattern,")").concat(w.modifier)}else g+="(?:".concat(_).concat(v,")").concat(w.modifier)}}if(c)r||(g+="".concat(h,"?")),g+=n.endsWith?"(?=".concat(m,")"):"$";else{var E=e[e.length-1],y="string"==typeof E?h.indexOf(E[E.length-1])>-1:void 0===E;r||(g+="(?:".concat(h,"(?=").concat(m,"))?")),y||(g+="(?=".concat(h,"|").concat(m,")"))}return new RegExp(g,flags(n))}function pathToRegexp(e,t,n){return e instanceof RegExp?regexpToRegexp(e,t):Array.isArray(e)?arrayToRegexp(e,t,n):stringToRegexp(e,t,n)}__name(lexer,"lexer"),__name(parse,"parse"),__name(match,"match"),__name(regexpToFunction,"regexpToFunction"),__name(escapeString,"escapeString"),__name(flags,"flags"),__name(regexpToRegexp,"regexpToRegexp"),__name(arrayToRegexp,"arrayToRegexp"),__name(stringToRegexp,"stringToRegexp"),__name(tokensToRegexp,"tokensToRegexp"),__name(pathToRegexp,"pathToRegexp");var escapeRegex=/[.+?^${}()|[\]\\]/g;function*executeRequest(e){const t=new URL(e.url).pathname;for(const n of[...routes].reverse()){if(n.method&&n.method!==e.method)continue;const a=match(n.routePath.replace(escapeRegex,"\\$&"),{end:!1}),r=match(n.mountPath.replace(escapeRegex,"\\$&"),{end:!1}),o=a(t),s=r(t);if(o&&s)for(const e of n.middlewares.flat())yield{handler:e,params:o.params,path:s.path}}for(const n of routes){if(n.method&&n.method!==e.method)continue;const a=match(n.routePath.replace(escapeRegex,"\\$&"),{end:!0}),r=match(n.mountPath.replace(escapeRegex,"\\$&"),{end:!1}),o=a(t),s=r(t);if(o&&s&&n.modules.length){for(const e of n.modules.flat())yield{handler:e,params:o.params,path:o.path};break}}}__name(executeRequest,"executeRequest");var pages_template_worker_default={async fetch(e,t,n){let a=e;const r=executeRequest(a);let o={},s=!1;const i=__name(async(e,c)=>{if(void 0!==e){let t=e;"string"==typeof e&&(t=new URL(e,a.url).toString()),a=new Request(t,c)}const u=r.next();if(!1===u.done){const{handler:e,params:r,path:c}=u.value,p={request:new Request(a.clone()),functionPath:c,next:i,params:r,get data(){return o},set data(e){if("object"!=typeof e||null===e)throw new Error("context.data must be an object");o=e},env:t,waitUntil:n.waitUntil.bind(n),passThroughOnException:__name(()=>{s=!0},"passThroughOnException")},d=await e(p);if(!(d instanceof Response))throw new Error("Your Pages function should return a Response");return cloneResponse(d)}{const e=await t.ASSETS.fetch(a);return cloneResponse(e)}},"next");try{return await i()}catch(e){if(s){const e=await t.ASSETS.fetch(a);return cloneResponse(e)}throw e}}},cloneResponse=__name(e=>new Response([101,204,205,304].includes(e.status)?null:e.body,e),"cloneResponse");export{pages_template_worker_default as default};